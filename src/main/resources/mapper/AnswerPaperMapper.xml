<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mcf.relationship.infra.mapper.AnswerPaperMapper">
    <select id="statisticsByAnswer" resultType="com.mcf.relationship.infra.model.AnswerStatisticsDO" parameterType="java.util.Map">
        SELECT
            userId,
            answerCnt,
            maxScoreAnswerPaperId,
            answerMaxScore,
            answerMaxScoreRank
        FROM (
                 SELECT
                     answer_id AS userId,
                     COUNT(*) AS answerCnt,
                     MAX(id) AS maxScoreAnswerPaperId,
                     MAX(score) AS answerMaxScore,
                     @rank := @rank + 1 AS answerMaxScoreRank
                 FROM r_answer_paper, (SELECT @rank := 0) r
                 WHERE answer_status = 2
                   AND complete_time BETWEEN #{startTime} AND #{endTime}
                 GROUP BY answer_id
                 ORDER BY MAX(score) DESC
             ) temp
    </select>

    <select id="statisticsByExaminer" resultType="com.mcf.relationship.infra.model.AnswerStatisticsDO" parameterType="java.util.Map">
        SELECT
            t.examinerId as userId,
            t.examCnt,
            t.examCntRank,
            t.hotExamPaperId
        FROM (
                 SELECT
                     examiner_id AS examinerId,
                     COUNT(*) AS examCnt,
                     @rank := @rank + 1 AS examCntRank,
            (
                SELECT exam_paper_id
                FROM r_answer_paper t2
                WHERE t2.examiner_id = r_answer_paper.examiner_id
                    AND t2.answer_status = 2
                    AND t2.complete_time BETWEEN #{startTime} AND #{endTime}
                         GROUP BY t2.exam_paper_id
                         ORDER BY COUNT(*) DESC
                         LIMIT 1
                         ) AS hotExamPaperId
                 FROM r_answer_paper, (SELECT @rank := 0) r
                 WHERE answer_status = 2
                   AND complete_time BETWEEN #{startTime} AND #{endTime}
                 GROUP BY examiner_id
                 ORDER BY COUNT(*) DESC
             ) t
    </select>
</mapper>
